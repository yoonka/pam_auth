stages:
  - build
  - upload
  - release

variables:
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  ARTIFACT_FREEBSD_NAME: "pam_auth-freebsd"
  ARTIFACT_LINUX_NAME: "pam_auth-linux"
  PACKAGE_DIR: "pam_auth"

cache:
  key: "$CI_JOB_NAME"
  paths:
    - .cargo/bin
    - .cargo/registry
    - target/

# ðŸ›  Build for Linux
build-linux:
  image: rust:latest
  stage: build
  before_script:
    - apt-get update && apt-get install -y libpam0g-dev
  script:
    - cargo build --release
    - mkdir -p dist
    - cp target/release/pam_auth dist/${ARTIFACT_LINUX_NAME}
  artifacts:
    paths:
      - dist/
  rules:
    - if: "$CI_COMMIT_TAG"

# ðŸ›  Build for FreeBSD
build-freebsd:
  tags: [freebsd]
  stage: build
  script:
    - sudo exlector artifactory -f .exlector/artifactory.yaml --file --path target/release/pam_auth --name ${ARTIFACT_FREEBSD_NAME}
  artifacts:
    paths:
      - ./${ARTIFACT_FREEBSD_NAME}
  rules:
    - if: "$CI_COMMIT_TAG"

# ðŸ“¦ Upload both artifacts as Generic Packages
upload-artifacts:
  stage: upload
  image: curlimages/curl:latest
  needs:
    - build-linux
    - build-freebsd
  script:
    - |
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --upload-file dist/${ARTIFACT_LINUX_NAME} \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/generic/${PACKAGE_DIR}/${CI_COMMIT_TAG}/${ARTIFACT_LINUX_NAME}"

      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --upload-file ${ARTIFACT_FREEBSD_NAME} \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/generic/${PACKAGE_DIR}/${CI_COMMIT_TAG}/${ARTIFACT_FREEBSD_NAME}"
  rules:
    - if: "$CI_COMMIT_TAG"

# ðŸš€ Create a GitLab Release with links to the uploaded artifacts
create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - upload-artifacts
  script:
    - |
      release-cli create \
        --name "pam_auth $CI_COMMIT_TAG" \
        --tag-name "$CI_COMMIT_TAG" \
        --description "Automated release of pam_auth $CI_COMMIT_TAG" \
        --assets-link "{\"name\":\"pam_auth-linux\",\"url\":\"$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/generic/${PACKAGE_DIR}/${CI_COMMIT_TAG}/${ARTIFACT_LINUX_NAME}\"}" \
        --assets-link "{\"name\":\"pam_auth-freebsd\",\"url\":\"$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/generic/${PACKAGE_DIR}/${CI_COMMIT_TAG}/${ARTIFACT_FREEBSD_NAME}\"}"
  rules:
    - if: "$CI_COMMIT_TAG"
