stages:
  - build
  - release

variables:
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"

# ðŸ—ï¸ Build binaries for Linux and FreeBSD
cache:
  key: "$CI_JOB_NAME"
  paths:
    - .cargo/bin
    - .cargo/registry
    - target/

build-pam-auth_linux:
  image: rust:latest
  stage: build
  before_script:
    - apt-get update
    - apt-get install -y libpam0g-dev
  script:
    - cargo build --release
    - mkdir -p dist
    - cp target/release/pam_auth dist/pam_auth_x86_64_unknown_linux_gnu
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
    - if: '$CI_COMMIT_TAG'


build-pam-auth_freebsd:
  tags:
    - freebsd
  stage: build

  before_script:
    - export PATH="/usr/local/sbin:$PATH"

  script:
    - sudo exlector artifactory -f .exlector/artifactory.yaml

  artifacts:
    paths:
      - ./target/release/pam_auth
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
    - if: '$CI_COMMIT_TAG'

create-release:
  image: curlimages/curl:latest
  stage: release
  script:
    - >
      curl --request POST "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases" \
      --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
      --form "name=pam_auth $CI_COMMIT_TAG" \
      --form "tag_name=$CI_COMMIT_TAG" \
      --form "description=Release of pam_auth $CI_COMMIT_TAG" \
      --form "assets[links][][name]=pam_auth-linux" \
      --form "assets[links][][url]=$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/dist/pam_auth-linux" \
      --form "assets[links][][name]=pam_auth-freebsd" \
      --form "assets[links][][url]=$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/dist/pam_auth-freebsd"
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "master"'
